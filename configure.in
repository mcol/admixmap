AC_INIT(src/admixmap/hapmixmap.cc)
AC_CANONICAL_SYSTEM
AM_INIT_AUTOMAKE(hapmixmap,0.3)
AM_CONFIG_HEADER(config.h)

dnl if test "`uname -m`" = "i686"; then
dnl 	proc="-march=i686"
dnl elif test "`uname -m`" = "x86_64"; then
dnl 	proc="-march=k8 -msse2 -mfpmath=sse"
dnl fi
dnl 
dnl if test "$CC" = "pathCC"; then
dnl 	if test "`uname -m`" = "x86_64"; then
dnl 		dnl yummy!
dnl 		dflags="-O3 -OPT:Ofast -fno-math-errno -ffast-math -fexceptions"
dnl 	fi
dnl fi

dnl 
dnl if test "$CC" = "g++"; then
dnl 	if test `uname -m` = "i686"; then
dnl 		dflags="-funroll-loops -fomit-frame-pointer"
dnl 	fi
dnl fi

dnl CXXFLAGS="-Wall -Werror $proc $dflags"

AC_DISABLE_SHARED
AC_PROG_CXX
AC_PROG_LIBTOOL
AC_PROG_INSTALL
AC_PROG_MAKE_SET

AC_HEADER_STDC

AC_DEFINE([__HAPMIXMAP__], [], [hapmixmap define])

AC_LANG_CPLUSPLUS

AC_CHECK_LIB(stdc++, main,,AC_MSG_ERROR(hapmixmap requires libstdc++))
dnl AM_PATH_GSL
AC_CHECK_HEADERS(stack,,AC_MSG_WARN(STL classes missing ?))
AC_CHECK_HEADERS(string,,AC_MSG_WARN(STL classes missing ?))
AC_CHECK_HEADERS(list,,AC_MSG_WARN(STL classes missing ?))
AC_CHECK_HEADERS(vector,,AC_MSG_WARN(STL classes missing ?))

AC_ARG_ENABLE(static-binary,[  --enable-static-binary  Build a static binary],
	      AC_MSG_WARN(Static binary will be built.),)
AC_ARG_ENABLE(parallel,[  --enable-parallel       Build the parallel version, using MPI],
	      AC_DEFINE([PARALLEL], [], [Parallel version]),AC_MSG_WARN(Serial version will be built.))

if test "$enable_parallel" = "yes"; then
	dnl AC_CHECK_HEADERS(mpi++.h,,AC_MSG_ERROR(MPI headers missing))
	PARALLEL_LIBS="-lmpich -lgmp -lsprng -lmpe"
	dnl -lmpich -lgmp -lsprng -lmpe
	dnl AC_CHECK_LIB(mpic, main,,AC_MSG_ERROR(hapmixmap requires libstdc++)) 
	dnl LIBS="$LIBS -lgmp -lsprng -lmpe"
else
	enable_parallel="no"
	PARALLEL_LIBS=""
fi

AC_SUBST([PARALLEL_LIBS])

if test "$enable_static_binary" = "yes"; then
	STATIC_LDFLAGS="-all-static"
else
	STATIC_LDFLAGS=""
	enable_static_binary="no"
fi

AC_SUBST([STATIC_LDFLAGS])

if test "$enable_parallel" = "yes" -a "$enable_static_binary" = "yes"; then
	AC_MSG_ERROR(Can't build a static parallel version.)
fi

dnl AC_CONFIG_SUBDIRS(src/bayeslib)
AC_OUTPUT([Makefile
	   src/Makefile
	   src/admixmap/Makefile
	   src/hapmixmap/Makefile
	   src/common/Makefile
	   src/bayeslib/Makefile
	   src/bayeslib/regression/Makefile
	   src/bayeslib/samplers/Makefile
	   src/bayeslib/utils/Makefile])

echo \
"------------------------------------------------------------------------
Configuration:

  Source code location:       ${srcdir}
  Compiler:                   ${CC}
  Compiler flags:             ${CFLAGS}
  Host System Type:           ${host}
  Install path:               ${prefix}
  Parallel version:           ${enable_parallel}
  Static binary:              ${enable_static_binary}

  See config.h for further configuration information.
------------------------------------------------------------------------"
